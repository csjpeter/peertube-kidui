<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<meta http-equiv="Content-Security-Policy" content="default-src 'self' blob: data:; media-src 'self' blob: data:; script-src 'self' blob:; script-src-attr 'self' 'unsafe-inline' blob:; script-src-elem 'self' 'unsafe-inline'; style-src-elem 'self' 'unsafe-inline';">-->
    <meta http-equiv="Content-Security-Policy" content="
      default-src     'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      media-src       'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      img-src         'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      font-src        'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      worker-src      'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      script-src      'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      script-src-elem 'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      script-src-attr 'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      style-src       'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      style-src-elem  'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
    ">
    <title>Kid-Friendly PeerTube</title>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const BASE_URL = `${window.location.protocol}//${window.location.hostname}`;
            const API_URL = `${window.location.protocol}//${window.location.hostname}/api/v1`;
            let currentVideos = [];
            let currentIndex = 0;

            // suggested

            async function loadSuggestedVideos() {
                const response = await fetch(`${API_URL}/videos?sort=-views`);
                const data = await response.json();
                displayVideos(data.data);
                clearChannelList();
                clearPlaylistList();
            }

            function clearVideoList() {
                document.getElementById('video-list').innerHTML = '';
            }

            function displayVideos(videos) {
                clearVideoList();
                const listEl = document.getElementById('video-list');
                videos.forEach(video => {
                    let div = document.createElement('div');
                    div.classList.add('video-item');
                    let thumbnailUrl = `${BASE_URL}${video.thumbnailPath}`;
                    div.innerHTML = `<img src="${thumbnailUrl}" alt="Thumbnail"><br>${video.name}`;
                    div.onclick = () => playVideo(video);
                    listEl.appendChild(div);
                });
            }

            // channels

            async function loadChannels() {
                const response = await fetch(`${API_URL}/video-channels`);
                const data = await response.json();
                displayChannels(data.data);
                clearVideoList();
                clearPlaylistList();
            }

            function clearChannelList() {
                document.getElementById('channel-list').innerHTML = '';
                document.getElementById('current-channel').innerHTML = '';
            }

            function displayChannels(channels) {
                clearChannelList();

                const listEl = document.getElementById('channel-list');
                channels.forEach(channel => {
                    let div = document.createElement('div');
                    div.classList.add('list-item');
                    div.innerHTML = `${channel.displayName}`;
                    //div.onclick = () => loadPlaylists(channel);
                    div.onclick = () => loadChannelVideos(channel);
                    listEl.appendChild(div);
                });
            }

            async function loadChannelVideos(channel) {
                clearChannelList();

                const currChEl = document.getElementById('current-channel');
                currChEl.innerHTML = `<h1>${channel.displayName}</h1>`;

                let url = `${API_URL}/video-channels/${channel.name}/videos`;
                const response = await fetch(url);
                const data = await response.json();
                displayVideos(data.data);
                loadPlaylists(channel);
            }

            // playlists

            async function loadPlaylists(channel) {
                const response = await fetch(`${API_URL}/video-channels/${channel.name}/video-playlists`);
                const data = await response.json();
                displayPlaylists(data.data);
            }

            function displayPlaylists(playlists) {
                clearPlaylistList();

                const listEl = document.getElementById('playlist-list');
                playlists.forEach(playlist => {
                    let div = document.createElement('div');
                    div.classList.add('list-item');
                    div.innerHTML = `${playlist.displayName}`;
                    div.onclick = () => loadPlaylistVideos(playlist);
                    listEl.appendChild(div);
                });
            }

            function clearPlaylistList() {
                document.getElementById('playlist-list').innerHTML = '';
                document.getElementById('current-playlist').innerHTML = '';
            }

            async function loadPlaylistVideos(playlist) {
                clearPlaylistList();

                const currPlEl = document.getElementById('current-playlist');
                currPlEl.innerHTML = `<h2>${playlist.displayName}</h2>`;

                let url = `${API_URL}/video-playlists/${playlist.id}/videos`;
                const response = await fetch(url);
                const data = await response.json();
                displayPlaylistVideos(data.data);
            }

            function displayPlaylistVideos(videos) {
                clearVideoList();
                const listEl = document.getElementById('video-list');
                videos.forEach(obj => {
                    let div = document.createElement('div');
                    div.classList.add('video-item');
                    let thumbnailUrl = `${BASE_URL}${obj.video.thumbnailPath}`;
                    div.innerHTML = `<img src="${thumbnailUrl}" alt="Thumbnail"><br>${obj.video.name}`;
                    div.onclick = () => playVideo(obj.video);
                    listEl.appendChild(div);
                });
            }

            // play video

            function playVideo(video) {
                clearVideoList();
                clearPlaylistList();
                clearChannelList();

                const currViEl = document.getElementById('current-playlist');
                currViEl.innerHTML = `<h1>${video.name}</h1>`;

                const currDescEl = document.getElementById('video-description');
                currDescEl.innerHTML = `<p>${video.description}</p>`;

                currentIndex = currentVideos.findIndex(v => v.id === video.id);
                const playerContainer = document.getElementById('player-container');
                const player = document.getElementById('player');
                player.src = `blob:${BASE_URL}/${video.uuid}`;
                player.play();
                playerContainer.style.display = 'flex';
            }

            document.getElementById('player').addEventListener('click', function() {
                this.paused ? this.play() : this.pause();
            });

            // debugging content

            function showCookies() {
                document.getElementById('cookie-info').textContent = document.cookie || "No cookies received.";
            }
            showCookies();

            // Load suggested videos by default
            loadSuggestedVideos();

            // Expose functions to global scope
            window.loadChannels = loadChannels;
            window.loadSuggestedVideos = loadSuggestedVideos;
        });
    </script>
    <style>
        body { display: flex; flex-direction: column; margin: 0; font-family: Arial, sans-serif; background: #f0f0f0; }
        #content-wrapper { display: flex; flex-grow: 1; }
        #sidebar { width: 250px; background: #2c3e50; color: white; padding: 10px; overflow-y: auto; }
        #sidebar button { width: 100%; padding: 10px; margin-bottom: 5px; border: none; background: #3498db; color: white; cursor: pointer; }
        #sidebar button:hover { background: #2980b9; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; padding: 10px; }
        #channel-list, #playlist-list, #video-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .list-item, .video-item { width: 200px; cursor: pointer; text-align: center; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .video-item img { width: 100%; border-radius: 5px; }
        .video-item:hover, .list-item:hover { background: #ecf0f1; }
        #player-container { display: none; align-items: center; justify-content: center; }
        video { width: 90%; height: 80vh; background: black; border-radius: 10px; box-shadow: 0px 0px 10px rgba(0,0,0,0.5); }
        #cookie-info { background: #ddd; padding: 10px; font-size: 12px; border-top: 1px solid #bbb; overflow-wrap: break-word; }
    </style>
</head>
<body>
    <div id="content-wrapper">
        <div id="sidebar">
            <button onclick="loadChannels()">Channels</button>
            <button onclick="loadSuggestedVideos()">Suggested Videos</button>
        </div>
        <div id="main-content">
            <div id="current-channel"></div>
            <div id="channel-list"></div>

            <div id="current-playlist"></div>
            <div id="playlist-list"></div>

            <div id="video-list"></div>

            <div id="current-video"></div>
            <div id="player-container">
                <video id="player" controls></video>
            </div>
            <div id="video-description"></div>

        </div>
    </div>
    <div id="cookie-info"></div>
</body>
</html>
