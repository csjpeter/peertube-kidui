<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<meta http-equiv="Content-Security-Policy" content="default-src 'self' blob: data:; media-src 'self' blob: data:; script-src 'self' blob:; script-src-attr 'self' 'unsafe-inline' blob:; script-src-elem 'self' 'unsafe-inline'; style-src-elem 'self' 'unsafe-inline';">-->
    <meta http-equiv="Content-Security-Policy" content="
      default-src     'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      media-src       'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      img-src         'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      font-src        'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      worker-src      'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      script-src      'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      script-src-elem 'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      script-src-attr 'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      style-src       'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      style-src-elem  'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
    ">
    <title>Kid-Friendly PeerTube</title>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const BASE_URL = `${window.location.protocol}//${window.location.hostname}`;
            const API_URL = `${window.location.protocol}//${window.location.hostname}/api/v1`;
            let currentVideos = [];
            let currentIndex = 0;

            function clearPage() {
                document.getElementById('page-title').innerHTML = '';
                document.getElementById('video-list').innerHTML = '';
                document.getElementById('channel-list').innerHTML = '';
                document.getElementById('playlist-list').innerHTML = '';

                const embedEl = document.getElementById('embed-player');
                embedEl.src = "";
                embedEl.style.display = 'none';
                const currDescEl = document.getElementById('video-description');
                currDescEl.innerHTML = `<p></p>`;
            }

            function showVideoList(videos) {
                currentVideos = videos;
                currentIndex = 0;

                const listEl = document.getElementById('video-list');
                videos.forEach(video => {
                    let vid = video.video ?? video;

                    if (!vid || !vid.thumbnailPath || !vid.name) {
                        console.warn("Skipping invalid video entry:", vid);
                        return;
                    }

                    let div = document.createElement('div');
                    div.classList.add('video-item');
                    let thumbnailUrl = `${BASE_URL}${vid.thumbnailPath}`;
                    div.innerHTML = `<img src="${thumbnailUrl}" alt="Thumbnail"><br>${vid.name}`;
                    div.onclick = () => playVideo(vid);
                    listEl.appendChild(div);
                });
            }


            // suggested

            async function loadSuggestedVideos() {
                const response = await fetch(`${API_URL}/videos?sort=-views`);
                const data = await response.json();

                clearPage();

                const currChEl = document.getElementById('page-title');
                currChEl.innerHTML = `<h1>Aj치nlatok</h1>`;

                showVideoList(data.data);
            }
            window.loadSuggestedVideos = loadSuggestedVideos;

            // channels

            async function loadChannels() {
                const response = await fetch(`${API_URL}/video-channels`);
                const data = await response.json();
                let channels = data.data;

                clearPage();

                const currChEl = document.getElementById('page-title');
                currChEl.innerHTML = `<h1>Csatorn치k</h1>`;

                const listEl = document.getElementById('channel-list');
                channels.forEach(channel => {
                    let div = document.createElement('div');
                    div.classList.add('list-item');
                    div.innerHTML = `${channel.displayName}`;
                    div.onclick = () => loadChannelVideos(channel);
                    listEl.appendChild(div);
                });
            }
            window.loadChannels = loadChannels;

            async function loadChannelVideos(channel) {
                let url = `${API_URL}/video-channels/${channel.name}/videos`;
                const response = await fetch(url);
                const data = await response.json();

                clearPage();

                const currChEl = document.getElementById('page-title');
                currChEl.innerHTML = `<h1>${channel.displayName}</h1>`;

                showVideoList(data.data);

                loadPlaylists(channel);
            }

            // playlists

            async function loadPlaylists(channel) {
                const response = await fetch(`${API_URL}/video-channels/${channel.name}/video-playlists`);
                const data = await response.json();
                let playlists = data.data;

                const listEl = document.getElementById('playlist-list');
                playlists.forEach(playlist => {
                    let div = document.createElement('div');
                    div.classList.add('list-item');
                    div.innerHTML = `${playlist.displayName}`;
                    div.onclick = () => loadPlaylistVideos(playlist);
                    listEl.appendChild(div);
                });
            }

            async function loadPlaylistVideos(playlist) {
                let url = `${API_URL}/video-playlists/${playlist.id}/videos`;
                const response = await fetch(url);
                const data = await response.json();

                clearPage();

                const currPlEl = document.getElementById('page-title');
                currPlEl.innerHTML = `<h1>${playlist.displayName}</h1>`;

                showVideoList(data.data);
            }

            // play video

            function nextVideo() {
                if (currentIndex < currentVideos.length - 1)
                {
                    currentIndex++;
                    video = currentVideos[currentIndex];
                    let vid = video.video ?? video;
                    playVideo(vid);
                }
            }
            window.nextVideo = nextVideo;

            function prevVideo() {
                if (currentIndex > 0)
                {
                    currentIndex--;
                    video = currentVideos[currentIndex];
                    let vid = video.video ?? video;
                    playVideo(vid);
                }
            }
            window.prevVideo = prevVideo;

            function playVideo(video) {
                clearPage();

                currentIndex = currentVideos.findIndex(v => v.id === video.id);

                const currViEl = document.getElementById('page-title');
                currViEl.innerHTML = `<h1>${video.name}</h1>`;

                const currDescEl = document.getElementById('video-description');
                if (video.description != null)
                    currDescEl.innerHTML = `<p>${video.description}</p>`;
                else
                    currDescEl.innerHTML = `<p></p>`;

                const playerContainer = document.getElementById('embed-container');
                    playerContainer.style.display = 'flex';
                const embedEl = document.getElementById('embed-player');
                embedEl.src = video.embedPath;
                embedEl.style.display = 'block';

                //console.log(video);
                //const playerContainer = document.getElementById('player-container');
                //    playerContainer.style.display = 'flex';
                //const player = document.getElementById('player');
                /*
                video.files.forEach(file => {
                    currDescEl.innerHTML += file.embedPath;
                    player.src = `blob:${BASE_URL}/${file.embedPath}`;
                    //player.src = `blob:${BASE_URL}/${file.fileUrl}`;
                    player.play();
                });*/
            }

            loadSuggestedVideos();
        });
    </script>
    <style>
        body { display: flex; flex-direction: column; margin: 0; font-family: Arial, sans-serif; background: #f0f0f0; }
        #channel-list, #playlist-list, #video-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .list-item, .video-item { width: 200px; cursor: pointer; text-align: center; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .video-item img { width: 100%; border-radius: 5px; }
        .video-item:hover, .list-item:hover { background: #ecf0f1; }
        #player-container { display: none; align-items: center; justify-content: center; }
        video { width: 90%; height: 80vh; background: black; border-radius: 10px; box-shadow: 0px 0px 10px rgba(0,0,0,0.5); }
        #embed-container { display: none; align-items: center; justify-content: center; }
        #embed-player { width: 90%; height: 80vh; background: black; border-radius: 10px; box-shadow: 0px 0px 10px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div id="content-wrapper">
        <div id="topbar">
            <button onclick="prevVideo()">&lt;---</button>
            <button onclick="loadSuggestedVideos()">Aj치nlatok</button>
            <button onclick="loadChannels()">Csatorn치k</button>
            <button onclick="nextVideo()">---&gt;</button>
        </div>
        <div id="main-content">
            <div id="page-title"></div>

            <div id="channel-list"></div>
            <div id="playlist-list"></div>
            <div id="video-list"></div>

            <div id="embed-container">
                <iframe id="embed-player"></iframe>
            </div>
            <!--
            <div id="player-container">
                <video id="player" controls></video>
            </div>
            -->
            <div id="video-description"></div>

        </div>
    </div>
</body>
</html>
