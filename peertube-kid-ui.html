<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<meta http-equiv="Content-Security-Policy" content="default-src 'self' blob: data:; media-src 'self' blob: data:; script-src 'self' blob:; script-src-attr 'self' 'unsafe-inline' blob:; script-src-elem 'self' 'unsafe-inline'; style-src-elem 'self' 'unsafe-inline';">-->
    <meta http-equiv="Content-Security-Policy" content="
      default-src     'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      media-src       'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      img-src         'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      font-src        'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      worker-src      'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      script-src      'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      script-src-elem 'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      script-src-attr 'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      style-src       'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
      style-src-elem  'self' 'unsafe-inline' 'unsafe-eval' blob: data:;
    ">
    <title>Kid-Friendly PeerTube</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
        }

        #content-wrapper {
            display: flex;
            flex: 1; /* Allow content-wrapper to grow and fill available space */
        }

        #left-bar, #right-bar {
            width: 150px; /* Adjust width as needed */
            background-color: #f0f0f0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center buttons horizontally */
            justify-content: center; /* Center buttons vertically */
        }

        #main-content {
            flex: 1; /* Allow main-content to grow and fill remaining space */
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content horizontally */
            justify-content: flex-start; /* Align content to the top */
            padding: 20px;
        }

        #content-list {
            display: none;
            flex-wrap: wrap;
            justify-content: center;
        }

        .video-item, .list-item {
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
            cursor: pointer;
        }

        #embed-container {
            width: 80%; /* Adjust as needed */
            max-width: 800px; /* Maximum width */
            margin: 20px 0;
            display: none;
        }

        #embed-player {
            width: 100%;
            height: 450px; /* Adjust height as needed */
            display: none;
        }

        #video-description {
            width: 80%;
            max-width: 800px;
            margin-top: 20px;
            text-align: center;
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const BASE_URL = `${window.location.protocol}//${window.location.hostname}`;
            const API_URL = `${window.location.protocol}//${window.location.hostname}/api/v1`;
            let currentVideos = [];
            let currentIndex = 0;

            function clearPage() {
                document.getElementById('page-title').innerHTML = '';
                document.getElementById('content-list').innerHTML = '';
                document.getElementById('content-list').style.display = 'none';

                const embedEl = document.getElementById('embed-player');
                embedEl.src = "";
                embedEl.style.display = 'none';
                const currDescEl = document.getElementById('video-description');
                currDescEl.innerHTML = `<p></p>`;
            }

            function showVideoList(videos) {
                currentVideos = videos;
                currentIndex = 0;

                const listEl = document.getElementById('content-list');
                listEl.style.display = 'flex';
                videos.forEach(video => {
                    let vid = video.video ?? video;

                    if (!vid || !vid.thumbnailPath || !vid.name) {
                        console.warn("Skipping invalid video entry:", vid);
                        return;
                    }

                    let div = document.createElement('div');
                    div.classList.add('video-item');
                    let thumbnailUrl = `${BASE_URL}${vid.thumbnailPath}`;
                    div.innerHTML = `<img src="${thumbnailUrl}" alt="Thumbnail"><br>${vid.name}`;
                    div.onclick = () => playVideo(vid);
                    listEl.appendChild(div);
                });
            }


            // suggested

            async function loadSuggestedVideos() {
                const response = await fetch(`${API_URL}/videos?sort=-views`);
                const data = await response.json();

                clearPage();

                const currChEl = document.getElementById('page-title');
                currChEl.innerHTML = `<h1>Ajánlatok</h1>`;
                currChEl.style.display = 'block';

                showVideoList(data.data);
            }
            window.loadSuggestedVideos = loadSuggestedVideos;

            // channels

            async function loadChannels() {
                const response = await fetch(`${API_URL}/video-channels`);
                const data = await response.json();
                let channels = data.data;

                clearPage();

                const currChEl = document.getElementById('page-title');
                currChEl.innerHTML = `<h1>Csatornák</h1>`;
                currChEl.style.display = 'block';

                const listEl = document.getElementById('content-list');
                listEl.style.display = 'flex';
                channels.forEach(channel => {
                    let div = document.createElement('div');
                    div.classList.add('list-item');
                    div.innerHTML = `${channel.displayName}`;
                    div.onclick = () => loadChannelVideos(channel);
                    listEl.appendChild(div);
                });
            }
            window.loadChannels = loadChannels;

            async function loadChannelVideos(channel) {
                let url = `${API_URL}/video-channels/${channel.name}/videos`;
                const response = await fetch(url);
                const data = await response.json();

                clearPage();

                const currChEl = document.getElementById('page-title');
                currChEl.innerHTML = `<h1>${channel.displayName}</h1>`;
                currChEl.style.display = 'block';

                loadPlaylists(channel);

                showVideoList(data.data);
            }

            // playlists

            async function loadPlaylists(channel) {
                const response = await fetch(`${API_URL}/video-channels/${channel.name}/video-playlists`);
                const data = await response.json();
                let playlists = data.data;

                const listEl = document.getElementById('content-list');
                listEl.style.display = 'flex';
                playlists.forEach(playlist => {
                    let div = document.createElement('div');
                    div.classList.add('list-item');
                    div.innerHTML = `${playlist.displayName}<br/>`;
                    div.onclick = () => loadPlaylistVideos(playlist);
                    //listEl.appendChild(div);
                    listEl.prepend(div);
                });
            }

            async function loadPlaylistVideos(playlist) {
                let url = `${API_URL}/video-playlists/${playlist.id}/videos`;
                const response = await fetch(url);
                const data = await response.json();

                clearPage();

                const currPlEl = document.getElementById('page-title');
                currPlEl.innerHTML = `<h1>${playlist.displayName}</h1>`;
                currPlEl.style.display = 'block';

                showVideoList(data.data);
            }

            // play video

            function nextVideo() {
                if (currentIndex < currentVideos.length - 1)
                {
                    currentIndex++;
                    video = currentVideos[currentIndex];
                    let vid = video.video ?? video;
                    playVideo(vid);
                }
            }
            window.nextVideo = nextVideo;

            function prevVideo() {
                if (currentIndex > 0)
                {
                    currentIndex--;
                    video = currentVideos[currentIndex];
                    let vid = video.video ?? video;
                    playVideo(vid);
                }
            }
            window.prevVideo = prevVideo;

            function playVideo(video) {
                clearPage();

                currentIndex = currentVideos.findIndex(v => v.id === video.id);

                const currViEl = document.getElementById('page-title');
                currViEl.innerHTML = `<h4>${video.name}</h4>`;
                currViEl.style.display = 'none';

                const currDescEl = document.getElementById('video-description');
                if (video.description != null)
                    currDescEl.innerHTML = `<p>${video.description}</p>`;
                else
                    currDescEl.innerHTML = `<p></p>`;

                const playerContainer = document.getElementById('embed-container');
                    playerContainer.style.display = 'flex';
                const embedEl = document.getElementById('embed-player');
                let path = video.embedPath+"?autoplay=true"
                embedEl.src = path;
                embedEl.style.display = 'block';

                //console.log(video);
                //const playerContainer = document.getElementById('player-container');
                //    playerContainer.style.display = 'flex';
                //const player = document.getElementById('player');
                /*
                video.files.forEach(file => {
                    currDescEl.innerHTML += file.embedPath;
                    player.src = `blob:${BASE_URL}/${file.embedPath}`;
                    //player.src = `blob:${BASE_URL}/${file.fileUrl}`;
                    player.play();
                });*/
            }

            loadSuggestedVideos();
        });
    </script>
</head>
<body>
    <div id="content-wrapper">
        <div id="left-bar">
            <button onclick="loadSuggestedVideos()">Ajánlatok</button>
            <button onclick="prevVideo()">&#8592;</button>
        </div>
        <div id="main-content">
            <div id="page-title"></div>

            <div id="content-list"></div>

            <div id="embed-container">
                <iframe id="embed-player" allowfullscreen></iframe>
            </div>
            <!--
            <div id="player-container">
                <video id="player" controls></video>
            </div>
            -->
            <div id="video-description"></div>

        </div>
        <div id="right-bar">
            <button onclick="loadChannels()">Csatornák</button>
            <button onclick="nextVideo()">&#8594;</button>
        </div>
    </div>
</body>
</html>
